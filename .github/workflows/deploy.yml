name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

# GitHub Pages 배포 권한 설정
permissions:
  contents: write # gh-pages에 푸시하려면 write 필요!
  pages: write
  id-token: write

# 동시 배포 방지
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: "react/pnpm-lock.yaml"

      - name: Install React dependencies
        working-directory: ./react
        run: pnpm install

      - name: Build React
        working-directory: ./react
        run: pnpm build

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          # 메인 파일들 복사 (빌드 필요 없음)
          cp index.html deploy/
          cp index.css deploy/
          cp index.js deploy/
          # Shared 리소스 복사
          cp -r shared deploy/
          # Vanilla 복사 (빌드 필요 없음)
          cp -r vanillia deploy/
          # React 빌드 결과물 복사 (dist 내부 파일들을 react/ 폴더로)
          mkdir -p deploy/react
          cp -r react/dist/* deploy/react/
          # 404.html 생성: SPA 라우팅 처리
          # 1. react/404.html: index.html과 동일하게 (서브디렉토리 내부 라우팅용)
          cp deploy/react/index.html deploy/react/404.html
          # 2. 루트 404.html: React 앱 경로인 경우 React 앱 로드
          # GitHub Pages는 루트의 404.html만 인식하므로, 여기서 React 앱 경로를 처리
          # React Router가 현재 URL을 읽어서 라우팅 처리 (basename: "/doakumize-kit/react" 설정됨)
          cp deploy/react/index.html deploy/404.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          # 배포 브랜치
          publish_branch: gh-pages
          # .nojekyll 파일 추가 (GitHub Pages Jekyll 비활성화)
          enable_jekyll: false
          # 강제 푸시 (orphan)
          force_orphan: true
